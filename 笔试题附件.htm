<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ZhuoZhuo</title>
</head>

<body>
  <script>
    // ä¸‹åˆ—å¸¸é‡ä¸å¯ä¿®æ”¹
    const testStr = 'æ„Ÿè°¢å‚ä¸ZhuoZhuoå‰ç«¯æ‹›è˜ğŸ˜„';
    const imageFileName = 'test.png';
    const txtFileName = 'test.txt';
    const imageWidth = 3;
    const imageHeight = 4;

    // è¡¥å…¨ä¸‹åˆ—å‡½æ•°é€»è¾‘
    // ç›¸å…³å‚è€ƒé“¾æ¥
    // https://developer.mozilla.org/en-US/docs/Web/API/ImageData
    // https://en.wikipedia.org/wiki/Alpha_compositing

    function getImageArrayByString(str) {
      // TODO å°†ä¼ å…¥å­—ç¬¦ä¸²è½¬ä¸ºåƒç´ æ•°ç»„ï¼Œæ ¼å¼è¦æ±‚è¯·å‚è€ƒå‡½æ•°`downloadImage`
      // const blob = new Blob([str])
      // console.log(blob)
      // const sBuffer = await blob.arrayBuffer()
      // const sData = new Uint8Array(sBuffer)
      //
      // const buffer = new ArrayBuffer(4 * imageWidth * imageHeight);
      // const view = new Uint8Array(buffer);
      // view.set(sData)
      //
      // const clampedArray = new Uint8ClampedArray(view, imageWidth, imageHeight)

      // return clampedArray
      const encoder = new TextEncoder();
      const byteArray = encoder.encode(str);

      const temp = []
      for (let i = 0; i < byteArray.length; i+=3) {
        temp.push(byteArray[i], byteArray[i+1], byteArray[i+2], 255)
      }

      return new Uint8ClampedArray(temp);
    }
    function downloadTxt(content, fileName) {
      // TODO è§¦å‘æµè§ˆå™¨ä¸‹è½½ï¼Œä¸‹è½½æ–‡ä»¶å†…å®¹ä¸ºä¼ å…¥çš„contentå†…å®¹ï¼Œæ ¼å¼æ˜¯fileNameæŒ‡å®šæ ¼å¼
      const blob = new Blob([content])
      const url = URL.createObjectURL(blob)
      const link = document.createElement('a')

      link.setAttribute('href', url)
      link.setAttribute('download', fileName)
      link.click()
    }
    function downloadImage({ fileName, data, width, height }) {
      const uintList = new Uint8ClampedArray(data); // Array to Uint8ClampedArray
      const imgData = new ImageData(uintList, width, height); // create new ImageData
      const canvas = document.createElement("canvas");
      canvas.width = width
      canvas.height = height
      const ctx = canvas.getContext("2d");

      ctx.putImageData(imgData, width, height)
      const url = canvas.toDataURL()
      const link = document.createElement('a')

      link.setAttribute('href', url)
      link.setAttribute('download', fileName)

      link.click()
    }
    function pixToData(pixList) {
      const res = [];
      for (let i = 0; i < pixList.length; i += 4) {
        res.push(pixList[i], pixList[i + 1], pixList[i + 2]);
      }
      return res;
    }
    function getStringByImageArray(list) {
      // TODO å°†åƒç´ æ•°ç»„è¿˜åŸä¸ºå­—ç¬¦ä¸²
      const data = pixToData(list);
      const decoder = new TextDecoder()
      const byteArray = new Uint8Array(data)

      return decoder.decode(byteArray)
    }

    // ä¸‹åˆ—ä»£ç ä¸å¯ä¿®æ”¹
    // æ‰§è¡Œå‡½æ•°ï¼ŒéªŒè¯å‡½æ•°åŠŸèƒ½

    // å­—ç¬¦ä¸²è½¬åƒç´ æ•°ç»„ï¼ˆ30åˆ†ï¼‰
    const pixData = getImageArrayByString(testStr);
    console.log(pixData);

    // åƒç´ æ•°ç»„ç»˜åˆ¶PNGå›¾ç‰‡å¹¶ä¸‹è½½ï¼ˆ30åˆ†ï¼‰
    downloadImage({ fileName: imageFileName, data: pixData, width: imageWidth, height: imageHeight });

    // // åƒç´ æ•°ç»„è¿˜åŸä¸ºå­—ç¬¦ä¸²ï¼ˆ30åˆ†ï¼‰
    const newStr = getStringByImageArray(pixData);
    console.log(newStr);

    // // ä¸‹è½½txtæ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹ä¸ºå­—ç¬¦ä¸²ï¼ˆ10åˆ†ï¼‰
    downloadTxt(newStr, txtFileName);
  </script>
</body>

</html>